# Build & push images to dev GAR
name: Build & push

on:
  # Run on push
  push:
    # Run on pushes to main
    branches:
      - 'staging*'
    # Run on tag pushes
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: read   # This is required for actions/checkout
  id-token: write  # This is required for requesting the JWT

env:
  # Do not modify following parameters
  DEV_WIP: projects/711793311977/locations/global/workloadIdentityPools/ci-cd/providers/wellsky-github
  DEV_SA: github-builder@viki-prod-mgmt-wsky.iam.gserviceaccount.com
  DEV_GAR_URL: us-east4-docker.pkg.dev/viki-prod-mgmt-wsky/images
  DEV_GCS_BUCKET: viki-static-prod
 
jobs:
  
  e2e-tests:
    name: Run Evaluations
    runs-on: ubuntu-latest
    steps:
      - name: Check E2E Golden Dataset Quality Gate
        run: |
          echo "temp disable e2e tests"
          # response=$(curl -s -w "\n%{http_code}" "https://ai-paperglass-api-p32qledfyq-uk.a.run.app/api/orchestrate/medication_extraction/test/report/sample/tldr/latest?f1_threshold=0.75&age_window=2880")
          # status_code=$(echo "$response" | tail -n1)
          # body=$(echo "$response" | sed '$d')
          
          # echo "E2E Golden Dataset Quality Gate Check - API Response Status Code: $status_code"
          
          # if [ "$status_code" != "200" ]; then
          #   echo "Error: API returned status code $status_code"
          #   echo "Response body: $body"
          #   exit 1
          # fi
          
          # is_passed=$(echo "$body" | jq -r '.is_overall_passed')
          # echo "E2E Golden Dataset Quality Gate Check - Overall Pass Status: $is_passed"
          
          # if [ "$is_passed" != "true" ]; then
          #   echo "Error: Quality check failed - Latest test results did not pass"
          #   echo "Full test results:"
          #   echo "$body" | jq '.'
          #   exit 1
          # fi
          
          # echo "âœ… E2E Golden Dataset Quality gate passed successfully"

  
  
  build-push-images:
    needs: e2e-tests
    strategy:
      matrix:
        service:
          - [autoscribe, api]
          - [autoscribe, widget]
          - [extract-and-fill, api]
          - [extract-and-fill, widget]
          - [demo, api]
          - [demo, dashboard]
          - [admin, api]
          - [admin, ui]
          - [nlparse, api]
          - [nlparse, widget]
          - [paperglass, api]
          - [paperglass, widget]
          - [medication_extraction, '']
          - [entity_extraction, '']          
          - [distributed_job_tracking, '']
    name: Build & push image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all tags
          # https://github.com/actions/checkout/issues/426#issuecomment-764193404
          # https://github.com/actions/checkout#Checkout-pull-request-HEAD-commit-instead-of-merge-commit
          # Always use SHA1 of the latest real commit, not the merge commit
          ref: ${{ github.ref == 'refs/heads/main' && github.sha || github.event.pull_request.head.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Generate image tag
        id: generate_image_tag
        run: |
          IMAGE_TAG=`git describe --tags --always`  # e.g. v1.34.0-3-g6772a6a3
          HEAD_REF=`git rev-parse HEAD`  # e.g. 6772a6a378ed9e1a382237497ac5bd9aeae73c13
          echo "Image tag: $IMAGE_TAG"
          echo "HEAD ref: $HEAD_REF"
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "HEAD_REF=$HEAD_REF" >> "$GITHUB_ENV"

      # Check for Dockerfile changes
      - name: Check Dockerfile changes
        id: dockerfile_check
        run: |
          if [ -z "${{matrix.service[1]}}" ]; then
            DOCKERFILE_PATH="${{matrix.service[0]}}/Dockerfile"
          else
            DOCKERFILE_PATH="${{matrix.service[0]}}/${{matrix.service[1]}}/Dockerfile"
          fi
          if git diff --quiet HEAD^ HEAD -- "$DOCKERFILE_PATH"; then
            echo "dockerfile_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "dockerfile_changed=true" >> "$GITHUB_OUTPUT"
            # Invalidate cache by setting a unique cache key
            echo "cache_key=$(date +%s)" >> "$GITHUB_OUTPUT"
          fi

      # Build & push to dev

      - name: Authenticate to Google Cloud
        id: auth_dev
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.DEV_WIP }}
          service_account: ${{ env.DEV_SA }}
          token_format: access_token

      - name: Login to Artifact Registry
        uses: docker/login-action@v2
        with:
          registry: us-east4-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth_dev.outputs.access_token }}
      
      - name: Copy shared directory for BFF services
        if: ${{ matrix.service[1] != '' }}
        run: |
          cp -r shared ${{matrix.service[0]}}/${{matrix.service[1]}}/

      - name: Build & push image for BFF
        uses: docker/build-push-action@v4
        if: ${{ matrix.service[1] != '' }}
        with:
          context: ${{ matrix.service[0] == 'admin' && matrix.service[1] == 'api' && '.' || format('{0}/{1}', matrix.service[0], matrix.service[1]) }}
          file: ${{ matrix.service[0] == 'admin' && matrix.service[1] == 'api' && 'admin/api/Dockerfile' || format('{0}/{1}/Dockerfile', matrix.service[0], matrix.service[1]) }}
          secrets: |
            "npmrc=${{ secrets.NPMRC }}"
          tags: |
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-${{matrix.service[1]}}:latest
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-${{matrix.service[1]}}:${{env.IMAGE_TAG}}
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-${{matrix.service[1]}}:${{env.HEAD_REF}}
          cache-from: |
            type=registry,ref=${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-${{matrix.service[1]}}-cache:${{ steps.dockerfile_check.outputs.cache_key || 'latest' }}
          cache-to: |
            type=registry,ref=${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-${{matrix.service[1]}}-cache:${{ steps.dockerfile_check.outputs.cache_key || 'latest' }},mode=max
          push: true
          no-cache: ${{ steps.dockerfile_check.outputs.dockerfile_changed == 'true' || matrix.service[0] == 'admin' }}
      
      - name: Copy shared directory for non-BFF services
        if: ${{ matrix.service[1] == '' }}
        run: |
          cp -r shared ${{matrix.service[0]}}/
      
      - name: Build & push image for non-BFF
        uses: docker/build-push-action@v4
        if: ${{ matrix.service[1] == '' }}
        with:
          context: ${{matrix.service[0]}}
          secrets: |
            "npmrc=${{ secrets.NPMRC }}"
          tags: |
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}:latest
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}:${{env.IMAGE_TAG}}
            ${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}:${{env.HEAD_REF}}
          cache-from: |
            type=registry,ref=${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-cache:${{ steps.dockerfile_check.outputs.cache_key || 'latest' }}
          cache-to: |
            type=registry,ref=${{env.DEV_GAR_URL}}/ai-${{matrix.service[0]}}-cache:${{ steps.dockerfile_check.outputs.cache_key || 'latest' }},mode=max
          push: true
          no-cache: ${{ steps.dockerfile_check.outputs.dockerfile_changed == 'true' }}

  build-push-frontends:
    needs: e2e-tests
    name: Build & push static
    runs-on: ubuntu-latest

    strategy:
      matrix:
        frontend:
          - sample
          - medwidget

    defaults:
      run:
        working-directory: ./frontends/${{matrix.frontend}}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all tags
          # https://github.com/actions/checkout/issues/426#issuecomment-764193404
          # https://github.com/actions/checkout#Checkout-pull-request-HEAD-commit-instead-of-merge-commit
          # Always use SHA1 of the latest real commit, not the merge commit
          ref: ${{ github.ref == 'refs/heads/main' && github.sha || github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./frontends/${{matrix.frontend}}/package-lock.json

      - name: Generate version
        id: generate_version
        run: |
          VERSION=`git describe --tags --always`  # e.g. v1.34.0-3-g6772a6a3
          HEAD_REF=`git rev-parse HEAD`  # e.g. 6772a6a378ed9e1a382237497ac5bd9aeae73c13
          echo "Version: $VERSION"
          echo "HEAD ref: $HEAD_REF"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "HEAD_REF=$HEAD_REF" >> "$GITHUB_ENV"

      - name: Authenticate to Google Cloud
        id: auth_dev
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.DEV_WIP }}
          service_account: ${{ env.DEV_SA }}
          # create_credentials_file: true
          # export_environment_variables: true
          # token_format: access_token

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 450.0.0'
          project_id: viki-dev-mgmt-wsky

      - name: 'Configure .npmrc'
        env:
          NPMRC: ${{ secrets.NPMRC }}
        run: |
          printf "$NPMRC" > ./.npmrc

      - name: 'Print info'
        run: |
          pwd
          ls -l
          gcloud info
          npm config get

      - name: 'Build static'
        run: |
          pwd
          ls -l
          npm ci
          npm run build

      - name: 'Copy static to GCS'
        run: |
          gsutil -m cp -r ./build/* gs://${{ env.DEV_GCS_BUCKET }}/frontends/${{ matrix.frontend }}/${{env.VERSION}}/
          gsutil -m cp -r ./build/* gs://${{ env.DEV_GCS_BUCKET }}/frontends/${{ matrix.frontend }}/${{env.HEAD_REF}}/
